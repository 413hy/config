#!/usr/bin/env bash
# ==========================================
# é€šç”¨ Linux é™æ€ç½‘å¡é…ç½®è„šæœ¬ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
# æ”¯æŒ: Debian/Ubuntu/Arch/Manjaro/CentOS/RHEL/Rocky/Fedora/openSUSE
# ==========================================

set -euo pipefail  # ä¸¥æ ¼æ¨¡å¼ï¼šé‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo "=========================================="
echo "ğŸŒ é€šç”¨ Linux ç½‘å¡é…ç½®å·¥å…· (ä¼˜åŒ–ç‰ˆ)"
echo "=========================================="
echo

# æ£€æŸ¥ root æƒé™
if [[ $EUID -ne 0 ]]; then
   echo "âŒ æ­¤è„šæœ¬éœ€è¦ root æƒé™è¿è¡Œ"
   echo "è¯·ä½¿ç”¨: sudo $0"
   exit 1
fi

# éªŒè¯ IP åœ°å€æ ¼å¼
validate_ip() {
    local ip=$1
    if [[ $ip =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]]; then
        IFS='.' read -r -a octets <<< "$ip"
        for octet in "${octets[@]}"; do
            if ((octet > 255)); then
                return 1
            fi
        done
        return 0
    fi
    return 1
}

# æ©ç è½¬å‰ç¼€å‡½æ•°ï¼ˆä¿®å¤ç‰ˆï¼‰
mask2cidr() {
    local mask=$1
    local nbits=0
    IFS='.' read -r -a octets <<< "$mask"
    
    for octet in "${octets[@]}"; do
        case $octet in
            255) ((nbits+=8));;
            254) ((nbits+=7));;
            252) ((nbits+=6));;
            248) ((nbits+=5));;
            240) ((nbits+=4));;
            224) ((nbits+=3));;
            192) ((nbits+=2));;
            128) ((nbits+=1));;
            0);;
            *) echo "âŒ æ— æ•ˆçš„å­ç½‘æ©ç "; exit 1;;
        esac
    done
    echo $nbits
}

# æ£€æµ‹ç½‘å¡
echo "æ£€æµ‹åˆ°ä»¥ä¸‹ç½‘å¡ï¼š"
interfaces=$(ip -o link show | awk -F': ' '{print $2}' | grep -v "lo")
echo "$interfaces"
echo

# è¾“å…¥ç½‘å¡åç§°
while true; do
    read -p "è¯·è¾“å…¥è¦é…ç½®çš„ç½‘å¡åç§°: " IFACE
    if ip link show "$IFACE" >/dev/null 2>&1; then
        break
    else
        echo "âŒ ç½‘å¡ $IFACE ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°è¾“å…¥"
    fi
done

# è¾“å…¥å¹¶éªŒè¯ IP åœ°å€
while true; do
    read -p "è¯·è¾“å…¥é™æ€IPåœ°å€ï¼ˆä¾‹å¦‚ 192.168.1.100ï¼‰: " IPADDR
    if validate_ip "$IPADDR"; then
        break
    else
        echo "âŒ IP åœ°å€æ ¼å¼æ— æ•ˆï¼Œè¯·é‡æ–°è¾“å…¥"
    fi
done

# è¾“å…¥å¹¶éªŒè¯å­ç½‘æ©ç 
while true; do
    read -p "è¯·è¾“å…¥å­ç½‘æ©ç ï¼ˆä¾‹å¦‚ 255.255.255.0ï¼‰: " NETMASK
    if validate_ip "$NETMASK"; then
        break
    else
        echo "âŒ å­ç½‘æ©ç æ ¼å¼æ— æ•ˆï¼Œè¯·é‡æ–°è¾“å…¥"
    fi
done

# è¾“å…¥å¹¶éªŒè¯ç½‘å…³
while true; do
    read -p "è¯·è¾“å…¥ç½‘å…³åœ°å€ï¼ˆä¾‹å¦‚ 192.168.1.1ï¼‰: " GATEWAY
    if validate_ip "$GATEWAY"; then
        break
    else
        echo "âŒ ç½‘å…³åœ°å€æ ¼å¼æ— æ•ˆï¼Œè¯·é‡æ–°è¾“å…¥"
    fi
done

# è¾“å…¥å¹¶éªŒè¯ DNS
while true; do
    read -p "è¯·è¾“å…¥DNSæœåŠ¡å™¨ï¼ˆä¾‹å¦‚ 8.8.8.8ï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰: " DNS
    IFS=',' read -r -a dns_array <<< "$DNS"
    valid=true
    for dns in "${dns_array[@]}"; do
        dns=$(echo "$dns" | xargs)  # å»é™¤ç©ºæ ¼
        if ! validate_ip "$dns"; then
            echo "âŒ DNS åœ°å€ $dns æ ¼å¼æ— æ•ˆ"
            valid=false
            break
        fi
    done
    if $valid; then
        break
    fi
done

PREFIX=$(mask2cidr "$NETMASK")

echo
echo "=========================================="
echo "å³å°†é…ç½®ä»¥ä¸‹ä¿¡æ¯ï¼š"
echo "ç½‘å¡ï¼š$IFACE"
echo "æ¨¡å¼ï¼šé™æ€"
echo "IPåœ°å€ï¼š$IPADDR/$PREFIX"
echo "æ©ç ï¼š$NETMASK"
echo "ç½‘å…³ï¼š$GATEWAY"
echo "DNSï¼š$DNS"
echo "=========================================="
echo

read -p "ç¡®è®¤ç»§ç»­ï¼Ÿ(y/n): " CONFIRM
[[ "$CONFIRM" != "y" && "$CONFIRM" != "Y" ]] && echo "æ“ä½œå·²å–æ¶ˆã€‚" && exit 0

echo
echo "â³ æ­£åœ¨é…ç½®ç½‘ç»œ..."

# å¤‡ä»½å½“å‰é…ç½®
BACKUP_DIR="/root/network_backup_$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"
ip addr show "$IFACE" > "$BACKUP_DIR/ip_addr.txt" 2>/dev/null || true
ip route show > "$BACKUP_DIR/routes.txt" 2>/dev/null || true
cp /etc/resolv.conf "$BACKUP_DIR/resolv.conf" 2>/dev/null || true
echo "ğŸ“ å·²å¤‡ä»½å½“å‰é…ç½®åˆ°: $BACKUP_DIR"

# åœæ­¢å¯èƒ½çš„ DHCP å®¢æˆ·ç«¯
dhclient -r "$IFACE" >/dev/null 2>&1 || true
systemctl stop NetworkManager >/dev/null 2>&1 || true

# æ¸…é™¤æ—§é…ç½®
ip addr flush dev "$IFACE" 2>/dev/null || true

# é…ç½®æ–° IP
if ip addr add "$IPADDR/$PREFIX" dev "$IFACE"; then
    echo "âœ… IP åœ°å€é…ç½®æˆåŠŸ"
else
    echo "âŒ IP åœ°å€é…ç½®å¤±è´¥"
    exit 1
fi

# å¯ç”¨ç½‘å¡
ip link set "$IFACE" up

# é…ç½®ç½‘å…³
if ip route | grep -q "^default"; then
    ip route replace default via "$GATEWAY" dev "$IFACE"
else
    ip route add default via "$GATEWAY" dev "$IFACE"
fi
echo "âœ… ç½‘å…³é…ç½®æˆåŠŸ"

# é…ç½® DNSï¼ˆä¿ç•™åŸæœ‰é…ç½®ï¼Œæ·»åŠ æ–°çš„ï¼‰
cp /etc/resolv.conf /etc/resolv.conf.bak 2>/dev/null || true
{
    echo "# Generated by network config script at $(date)"
    IFS=',' read -r -a dns_array <<< "$DNS"
    for dns in "${dns_array[@]}"; do
        dns=$(echo "$dns" | xargs)
        echo "nameserver $dns"
    done
    # ä¿ç•™åŸæœ‰çš„é nameserver è¡Œ
    grep -v "^nameserver" /etc/resolv.conf.bak 2>/dev/null || true
} > /etc/resolv.conf
echo "âœ… DNS é…ç½®æˆåŠŸ"

# æµ‹è¯•è¿æ¥
echo
echo "ğŸ§ª æµ‹è¯•ç½‘ç»œè¿æ¥..."
if ping -c 2 -W 3 "$GATEWAY" >/dev/null 2>&1; then
    echo "âœ… ç½‘å…³è¿æ¥æ­£å¸¸"
else
    echo "âš ï¸  æ— æ³• ping é€šç½‘å…³"
fi

if ping -c 2 -W 3 8.8.8.8 >/dev/null 2>&1; then
    echo "âœ… å¤–ç½‘è¿æ¥æ­£å¸¸"
else
    echo "âš ï¸  æ— æ³•è¿æ¥å¤–ç½‘"
fi

echo
echo "=========================================="
echo "âœ… é…ç½®å®Œæˆï¼å½“å‰ç½‘ç»œçŠ¶æ€ï¼š"
echo "=========================================="
echo
echo "ğŸ“Œ ç½‘å¡ä¿¡æ¯ï¼š"
ip addr show dev "$IFACE" | grep -E "inet |link/"
echo
echo "ğŸŒ è·¯ç”±è¡¨ï¼š"
ip route show
echo
echo "ğŸ§­ DNS é…ç½®ï¼š"
cat /etc/resolv.conf | grep nameserver
echo
echo "=========================================="
echo "âš ï¸  æ³¨æ„ï¼šå½“å‰é…ç½®ä¸ºä¸´æ—¶é…ç½®ï¼Œé‡å¯åä¼šä¸¢å¤±"
echo "å¦‚éœ€æ°¸ä¹…é…ç½®ï¼Œè¯·æ ¹æ®ä½ çš„å‘è¡Œç‰ˆä¿®æ”¹ç½‘ç»œé…ç½®æ–‡ä»¶ï¼š"
echo "  - Debian/Ubuntu: /etc/network/interfaces æˆ– /etc/netplan/*.yaml"
echo "  - CentOS/RHEL: /etc/sysconfig/network-scripts/ifcfg-$IFACE"
echo "  - Arch/Manjaro: /etc/systemd/network/*.network"
echo "=========================================="
echo
echo "æ¢å¤å‘½ä»¤ï¼ˆå¦‚éœ€å›æ»šï¼‰ï¼š"
echo "  å¤‡ä»½ç›®å½•: $BACKUP_DIR"
echo "=========================================="
